<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Redis 性能优化 | web 工程师知识系统</title>
  <meta name="author" content="少个分号">
  
  <meta name="description" content="Redis 集群原理redis 扩容三个阶段：

单机: redis支撑万级
一主多从： 一主多从，开启读写分离，例如1主2从3哨兵模式 一般能到10万级，其实本质上还是属于单实例
多主集群：多主多从，客户端分片 可以达到千万级别

一主多从模式使用 Redis 自带的哨兵（Sentinel）集群对">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Redis 性能优化">
  <meta property="og:site_name" content="web 工程师知识系统">

  
    <meta property="og:image" content="undefined">
  

  
    <link rel="alternative" href="/atom.xml" title="web 工程师知识系统" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">  
  <link rel="stylesheet" href="/css/sidenav.css" media="screen" type="text/css">  
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  

</head>
</html>
<body id="body" data-spy="scroll" data-target=".toc">
  <div class="container" id="container">
	<div class="content">
	  <div class="page-header">		
  <h1><a class="brand" href="/">web 工程师知识系统</a><span class="split"></span><span class="title">Redis 性能优化</span><span class="date" id="title-date"><i class="fa fa-clock-o"></i> 2020-03-21</span></h1>
</div>		

<div class="row page">
  <!-- cols -->	
  
  <div class="col-xs-12 col-sm-3 col-md-3 toc"> 
	<!-- toc -->
<script type="text/javascript">
		jQuery(document).ready(function() {
 		   generateWikiTOC('.note', '.toc',  2 , 2 );
		});
</script>
  </div><!-- col-md-3 -->
  
  

  
  <div class="col-xs-12 col-sm-9 col-md-9 note">
	

	  <!-- content -->
	  <h2 id="Redis-集群原理"><a href="#Redis-集群原理" class="headerlink" title="Redis 集群原理"></a>Redis 集群原理</h2><p>redis 扩容三个阶段：</p>
<ul>
<li>单机: redis支撑万级</li>
<li>一主多从： 一主多从，开启读写分离，例如1主2从3哨兵模式 一般能到10万级，其实本质上还是属于单实例</li>
<li>多主集群：多主多从，客户端分片 可以达到千万级别</li>
</ul>
<h3 id="一主多从模式"><a href="#一主多从模式" class="headerlink" title="一主多从模式"></a>一主多从模式</h3><p>使用 Redis 自带的哨兵（Sentinel）集群对实例进行状态监控与 Failover。Sentinel 是 Redis 自带的高可用组件，将 Redis 注册到由多个 Sentinel 组成的 Sentinel 集群后，Sentinel 会对 Redis 实例进行健康检查，当 Redis 发生故障后，Sentinel 会通过 Gossip 协议进行故障检测，确认宕机后会通过一个简化的 Raft 协议来提升 Slave 成为新的 Master。</p>
<p><img src="/性能优化/performance/redis-performance/1500839-3bb8dac58b9fac75.jpg" alt="img"></p>
<p>仅使用 1 个 Slave 节点进行冷备，如果有读写分离请求，可以建立多个 Read only slave 来进行读写分离。</p>
<p>如上图所示，通过向 Sentinel 集群注册 Master 节点实现实例的高可用，当提交 Master 实例的连接信息后，Sentinel 会主动探测所有的 Slave 实例并建立连接，定期检查健康状态。客户端通过多种资源发现策略如简单的 DNS 发现 Master 节点，将来有计划迁移到如 Consul 或 etcd 等资源发现组件 。</p>
<p>注意事项：</p>
<ul>
<li>只读 Slave 节点可以按照需求设置 slave-priority 参数为 0，防止故障切换时选择了只读节点而不是热备 Slave 节点；</li>
<li>Sentinel 进行故障切换后会执行 CONFIG REWRITE 命令将 SLAVEOF 配置落地，如果 Redis 配置中禁用了 CONFIG 命令，切换时会发生错误，可以通过修改 Sentinel 代码来替换 CONFIG 命令；</li>
<li>Sentinel Group 监控的节点不宜过多，实测超过 500 个切换过程偶尔会进入 TILT 模式，导致 Sentinel 工作不正常，推荐部署多个 Sentinel 集群并保证每个集群监控的实例数量小于 300 个；</li>
<li>Master 节点应与 Slave 节点跨机器部署，有能力的使用方可以跨机架部署，不推荐跨机房部署 Redis 主从实例；</li>
<li>Sentinel 切换功能主要依赖 down-after-milliseconds 和 failover-timeout 两个参数，down-after-milliseconds 决定了 Sentinel 判断 Redis 节点宕机的超时，使用 30000 作为阈值。而 failover-timeout 则决定了两次切换之间的最短等待时间，如果对于切换成功率要求较高，可以适当缩短 failover-timeout 到秒级保证切换成功，具体详见 Redis 官方文档；</li>
<li>单机网络故障等同于机器宕机，但如果机房全网发生大规模故障会造成主从多次切换，此时资源发现服务可能更新不够及时，需要人工介入。</li>
</ul>
<h3 id="多主集群模式"><a href="#多主集群模式" class="headerlink" title="多主集群模式"></a>多主集群模式</h3><p>redis 目前主流有三个集群方案可以选择：</p>
<ul>
<li>redis cluster  官方的集群方案</li>
<li>Twemproxy 推特、知乎在用</li>
<li>codis 豌豆荚团队开发</li>
</ul>
<h4 id="redis-cluster-官方集群"><a href="#redis-cluster-官方集群" class="headerlink" title="redis cluster 官方集群"></a>redis cluster 官方集群</h4><p>一组Redis Cluster是由多个Redis实例组成，官方推荐我们使用6实例，其中3个为主节点，3个为从结点。</p>
<p>一旦有主节点发生故障的时候，Redis Cluster可以选举出对应的从结点成为新的主节点，继续对外服务，从而保证服务的高可用性。那么对于客户端来说，知道知道对应的key是要路由到哪一个节点呢？原来，Redis Cluster 把所有的数据划分为16384个不同的槽位，可以根据机器的性能把不同的槽位分配给不同的Redis实例，对于Redis实例来说，他们只会存储部门的Redis数据，当然，槽的数据是可以迁移的，不同的实例之间，可以通过一定的协议，进行数据迁移。</p>
<p><img src="/性能优化/performance/redis-performance/377adab44aed2e73e06d2f3d2de6fe8e86d6fa0c.png" alt="img"></p>
<p>客户端是如何访问Redis Cluster里面的数据呢？首先客户端需要保存一份Redis Cluster槽相关的信息，也就是路由表，然后对即将访问的key进行哈希计算，计算出对应的槽位，然后向对应的Redis实例发起查询请求。如果访问的Redis实例中，的确保存着对应槽的数据信息，就会进行返回，否则向客户端返回一个Moved指令，让客户端到正确的地址进行获取。</p>
<h5 id="槽位算法"><a href="#槽位算法" class="headerlink" title="槽位算法"></a>槽位算法</h5><p>槽位的信息是通过 CRC16 实现的，如果给 key 增加 tag 还可以强制 key 所挂的操作等于 tag 所在的槽位。</p>
<pre><code class="shell">&gt; CLUSTER KEYSLOT somekey
11058
&gt; CLUSTER KEYSLOT foo{hash_tag}
(integer) 2515
&gt; CLUSTER KEYSLOT bar{hash_tag}
(integer) 2515
</code></pre>
<p>参考文档：<a href="https://redis.io/commands/cluster-keyslot" target="_blank" rel="noopener">https://redis.io/commands/cluster-keyslot</a></p>
<h5 id="跳转"><a href="#跳转" class="headerlink" title="跳转"></a>跳转</h5><p>当客户端向一个错误的节点发出指令后，该节点就会发现该指令的 key 所在的槽位并不归自己管理，这时服务器会发送一个特殊的跳转指令，告诉客户端去连接新的节点获取数据。</p>
<pre><code class="shell">GET X
-MOVED 3333 127.0.0.1:6381
</code></pre>
<h5 id="迁移"><a href="#迁移" class="headerlink" title="迁移"></a>迁移</h5><p>如果需要对集群中的 keys 迁移到另外一个服务器，可以使用 redis-trib 工具，该工具是由 ruby 编写，可以方便的完成迁移工作。</p>
<h5 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h5><p>Redis 集群可以为每个主节点设置多个从节点，当主节点发生故障，集群可以将其中一个节点提升为主节点。</p>
<h5 id="网络抖动设置"><a href="#网络抖动设置" class="headerlink" title="网络抖动设置"></a>网络抖动设置</h5><p>现实的网络会发生抖动，也就是偶尔不可达，但随后能通信，因此需要一个阈值决定是否真的发生了宕机。</p>
<p>这个值可以设置:</p>
<blockquote>
<p>Cluster-slave-validity-factor</p>
</blockquote>
<p>如果这个值为 0  集群不会抗拒网络抖动，会发生主从切换，如果这个值大于0，集群会通过重试确认主从。</p>
<h4 id="codis"><a href="#codis" class="headerlink" title="codis"></a>codis</h4><p>Codis是一个分布式Redis解决方案,对于上层的应用来说,连接到Codis Proxy和连接原生的RedisServer没有明显的区别,有部分命令不支持。Codis底层会处理请求的转发,不停机的数据迁移等工作,所有后边的一切事情,对于前面的客户端来说是透明的,可以简单的认为后边连接的是一个内存无限大的Redis服务.</p>
<p><img src="/性能优化/performance/redis-performance/5BD68FB50A584D53A186F0FC5C81212D.png" alt="image"></p>
<p>codis 组成部分：</p>
<ul>
<li>Codis-proxy: 实现redis协议,由于本身是无状态的,因此可以部署很多个节点</li>
<li>Codis-config :是codis的管理工具,包括添加/删除redis节点添加删除proxy节点,发起数据迁移等操作,自带httpserver,支持管理后台方式管理配置</li>
<li>Codis-server :是codis维护的redis分支,基于2.8.21分支,加入了slot的支持和原子的数据迁移指令; codis-proxy和codis-config只能和这个版本的redis交互才能正常运行</li>
<li>Coordination：支持 Zookeeper 或者 etcd</li>
</ul>
<p>使用 codis 的优势：</p>
<ul>
<li>对客户端透明,与codis交互方式和redis本身交互一样</li>
<li>支持在线数据迁移,迁移过程对客户端透明有简单的管理和监控界面</li>
<li>支持高可用,无论是redis数据存储还是代理节点</li>
<li>自动进行数据的均衡分配</li>
<li>最大支持1024个redis实例,存储容量海量</li>
<li>高性能</li>
</ul>
<p>使用了 codis 带来的限制：</p>
<ul>
<li>最大支持1024个redis实例 （redis cluster支持的槽位更多）</li>
<li>采用自有的redis分支,不能与原版的redis保持同步</li>
<li>某些命令不支持,比如事务命令、muti</li>
<li>redis 实例和单机相比下降 20% </li>
<li>国内开源产品,活跃度相对弱一些</li>
</ul>
<h4 id="数据指标"><a href="#数据指标" class="headerlink" title="数据指标"></a>数据指标</h4><p>官方数据表示Redis读的速度是110000次/s,写的速度是81000次/s 。</p>
<h3 id="大厂案例"><a href="#大厂案例" class="headerlink" title="大厂案例"></a>大厂案例</h3><h4 id="知乎-redis-优化情况"><a href="#知乎-redis-优化情况" class="headerlink" title="知乎 redis 优化情况"></a>知乎 redis 优化情况</h4><p>目前，Redis 在知乎的应用规模如下：</p>
<p>1）机器内存总量约 70TB，实际使用内存约 40TB；</p>
<p>2）平均每秒处理约 1500 万次请求，峰值每秒约 2000 万次请求；</p>
<p>3）每天处理约 1 万亿余次请求；</p>
<p>4）单集群每秒处理最高每秒约 400 万次请求；</p>
<p>5）集群实例与单机实例总共约 800 个；</p>
<p>6）实际运行约 16000 个 Redis 实例；</p>
<p>7）Redis 使用官方 3.0.7 版本，少部分实例采用 4.0.11 版本。</p>
<p>采用的是 Twemproxy 集群方案。</p>
<p><img src="/性能优化/performance/redis-performance/1500839-504df1bcc0e9cda3.jpg" alt="img"></p>
<h3 id="redis-常用工具"><a href="#redis-常用工具" class="headerlink" title="redis 常用工具"></a>redis 常用工具</h3><h4 id="redis-测试性能测试"><a href="#redis-测试性能测试" class="headerlink" title="redis 测试性能测试"></a>redis 测试性能测试</h4><p>用于性能测试</p>
<blockquote>
<p>./redis-benchmark -h 127.0.0.1 -p 6379 -d 1000 -c 100 -n 100000</p>
</blockquote>
<h4 id="redis-monitor"><a href="#redis-monitor" class="headerlink" title="redis monitor"></a>redis monitor</h4><p>用于redis 运行情况的监控</p>
<blockquote>
<p>redis 127.0.0.1:6379&gt; MONITOR </p>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://www.cnblogs.com/imstudy/p/9668257.html" target="_blank" rel="noopener">https://www.cnblogs.com/imstudy/p/9668257.html</a></li>
</ul>
	  

	  <div>
  		<center>
		  <div class="pagination">
<ul class="pagination">
	
	
	
	
	
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
			
		
	
		
	
		
	
		
	
		
	
		
			
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
			
		
	
		
			
			
		
	
		
	
		
	
		
			
			
			
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
	
	
		<li class="prev"><a href="/性能优化/performance/mysql-performance/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>prev</a></li>
	
	<li><a href="/"><i class="fa fa-archive"></i>Home</a></li>
	
		<li class="next"><a href="/性能优化/performance/performance-overview/" class="alignright next">next<i class="fa fa-arrow-circle-o-right"></i></a></li>
	
</ul>
</div>

		</center>
	  </div>
	  
	</div> <!-- col-md-9/col-md-12 -->
	
  </div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
	<footer> <p>
  
  &copy; 2020 少个分号
  
  <a href="/about" target="_blank">关于本站</a> |
  <a href="https://github.com/linksgo2011/wiki" target="_blank">github |</a>
  <a href="http://www.printf.cn" target="_blank">我的博客</a>
</p> </footer>
  </div> <!-- container-narrow -->
  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.tableofcontents.min.js"></script>
<script src="/js/tocgenerator.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


</body>
</html>
